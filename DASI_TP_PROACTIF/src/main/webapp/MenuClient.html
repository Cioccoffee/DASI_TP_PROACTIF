<!DOCTYPE html>
<!--
To change this license header, choose License Headers in Project Properties.
To change this template file, choose Tools | Templates
and open the template in the editor.
-->
<html>
    <head>
        <title>Proact'IF - Home</title>
        <meta charset="UTF-8">
        <meta name="viewport" content="width=device-width, initial-scale=1.0">
        <script src="https://code.jquery.com/jquery-3.3.1.min.js"></script>
    </head>
    <body>
        <h1>Proact'IF</h1>
        connecté en tant que <p id="nom-client"></p>
        <!--afficher nom client-->
        <button id="bouton-deconnexion-client">Deconnexion</button>
        <button id="bouton-menu-client">Menu</button>
        <h2>Historique des interventions demandées</h2>
        <!ld>
    <div id="div-historique" style="overflow:auto; height:100px; width:400px;">
        liste <br>
        liste <br>
        liste <br>
        liste <br>
        liste <br>
        liste <br>

    </div>
    <ul id="historique">

    </ul>

    <div id="div-intervention">
        <h2>Demande d'intervention</h2>
        <div id="div-choix-intervention" >
            <button id="bouton-intervention-animal" style="color:white;background-color:blue" onclick="interventionAnimal()">Animal</button>
            <button id="bouton-intervention-livraison" style="background-color:white" onclick="interventionLivraison()">Livraison</button>
            <button id="bouton-intervention-incident" style="background-color:white" onclick="interventionIncident()">Incident</button><br>
        </div>
        <div id="div-champs-intervention">
            <input type="hidden" id="champ-type-intervention" name="intervention" value="animal" />
            <div id="div-champs-intervention-specifiques">
                Type d'animal : <input type="text" id="champ-type-animal" name="type-animal" placeholder="Type d'animal" /><br>
            </div>
            Description : <input type="text" id="champ-description-intervention" name="description" placeholder="Description" value="" /><br>
        </div>
        <button id="bouton-intervention-valider" style="color:white;background-color:blue" onclick="demanderIntervention()">Valider</button>
    </div>

    <div>TODO write content</div>

    <script>

        function deconnexionClient() {
            $('#message').html('Connexion en cours...');

            $.ajax({
                url: './ActionServlet',
                method: 'POST',
                data: {
                    action: 'deconnecterClient'
                },
                dataType: 'json'
            }).done(function (data) {
                // ici votre code...
                // 
                // si connexion ok, aller sur la page suivante :
                window.location = "Accueil.html";
                // si connexion pas ok afficher un texte dans la div message :

            }).fail(function () {
                // ici votre code...

                // si connexion pas ok afficher un texte dans la div message :
                $('#message').html('Echec de la deconnexion');
            });
        }

        function historique() {

            $.ajax({
                url: './ActionServlet',
                method: 'GET',
                data: {
                    action: 'getHistoriqueClient'
                },
                dataType: 'json'
            }).done(function (data) {
                // ici votre code...
                // 
                var historique = data.historique;
                //on veut afficher avec un for each
                //date + type => transformer date
                //details
                var historiqueHtml = $("#historique");
                $.each(historique, function (i, historique) {
                    historiqueHtml.append('<li>'
                            + historique.debut + " - "
                            + historique.type + '</li>');
                }
                );
                // si connexion ok, aller sur la page suivante :
                //window.location = "Accueil.html";
                // si connexion pas ok afficher un texte dans la div message :

            }).fail(function () {
                // ici votre code...

                // si connexion pas ok afficher un texte dans la div message :
                $('#message').html('Echec de la récupération de lhistorique');
            });
        }

        function getNomClient() {
            $.ajax({
                url: './ActionServlet',
                method: 'GET',
                data: {
                    action: 'getNomClient'
                },
                dataType: 'json'
            }).done(function (data) {
                var client = data.client;
                $('#nom-client').html(client.nom + " " + client.prenom);
            }).fail(function () {
                $('#nom-client').html("pas trouvé");
            });
        }

        function demanderIntervention() {
            
            //appelle la bonne demande car nb de params différent
            var intervention = $('#champ-type-intervention').val();
            switch(intervention){
                case "animal":
                    demanderInterventionAnimal();
                    break;
                case "livraison":
                    demanderInterventionLivraison();
                    break;
                case "incident":
                    demanderInterventionIncident();
                    break;
                
            }
            
        }

        function demanderInterventionAnimal() {
            $.ajax({
                url: './ActionServlet',
                method: 'POST',
                data: {
                    action: 'demanderInterventionAnimal',
                    animal: $('#champ-type-animal').val(),
                    description: $('#champ-description-intervention').val()
                },
                dataType: 'json'
            }).done(function (data) {
                //Ajouter nouvelle ligne dans l'historique si intervention
                //bien attribuée
                
                var success = data.res.success;
                if(success === "true"){
                    //vider les champs = change technique --> marche pas
                    $('#champ-type-animal').empty();
                    $('#champ-description-intervention').empty();
                    
                    //afficher message confirmation
                    alert("L'intervention a bien été attribuée à un de nos employés")
                }else if(success ==="false"){
                    alert("L'intervention n'a pas pu être attribuée à un de nos"
                    +"employés. Veuillez réessayer dans queques instants")
                }
                
            }).fail(function () {
                alert("Houston, we got a problem")
            });
        
        }
        
        function demanderInterventionLivraison() {
            $.ajax({
                url: './ActionServlet',
                method: 'POST',
                data: {
                    action: 'demanderInterventionLivraison',
                    animal: $('#champ-prestataire').val(),
                    objet: $('#champ-objet').val(),
                    description: $('#champ-description-intervention').val()
                },
                dataType: 'json'
            }).done(function (data) {
                //Ajouter nouvelle ligne dans l'historique si intervention
                //bien attribuée
                //vider les champs
                
                var success = data.res.success;
                if(success === "true"){
                    //vider les champs
                    $('#champ-prestataire').attr("value","");
                    $('#champ-objet').attr("value","");
                    $('#champ-description-intervention').attr("value","");
                    
                    //afficher message confirmation
                    alert("L'intervention a bien été attribuée à un de nos employés")
                }else if(success ==="false"){
                    alert("L'intervention n'a pas pu être attribuée à un de nos"
                    +"employés. Veuillez réessayer dans queques instants")
                }
            }).fail(function () {
            });
        
        }
        
        function demanderInterventionIncident() {
            $.ajax({
                url: './ActionServlet',
                method: 'POST',
                data: {
                    action: 'demanderInterventionIncident',
                    //animal: $('#champ-type-incident').val(),
                    description: $('#champ-description-intervention').val()
                },
                dataType: 'json'
            }).done(function (data) {
                //Ajouter nouvelle ligne dans l'historique si intervention
                //bien attribuée
                //vider les champs
                
                var success = data.res.success;
                if(success === "true"){
                    //vider les champs
                    $('#champ-type-incident').attr("value","");
                    $('#champ-description-intervention').attr("value","");
                    
                    //afficher message confirmation
                    alert("L'intervention a bien été attribuée à un de nos employés")
                }else if(success ==="false"){
                    alert("L'intervention n'a pas pu être attribuée à un de nos"
                    +"employés. Veuillez réessayer dans queques instants")
                }
            }).fail(function () {
                
            });
        
        }
        
        function interventionAnimal() {
            $.ajax({
            }).done(function () {
                //set le bouton précédent à la couleur normale
                var currentButton = $('#champ-type-intervention').val();
                $('#bouton-intervention-'+currentButton+'').attr("style","background-color:white");
                //mettre le bon bouton en bleu
                $('#bouton-intervention-animal').attr("style","color:white;background-color:blue");
                //vider champ description
                document.getElementById('champ-description-intervention').value = "";
                //changer valeur action
                $('#div-champs-intervention-specifiques').html('Type d\'animal : <input type="text" id="champ-type-animal" name="type-animal" placeholder="Type d\'animal" /><br>');
                //mettre les bons champs
                $('#champ-type-intervention').attr("value","animal");
            }).fail(function () {
                $('#nom-client').html("pas trouvé");
            });
        }
        
        function interventionLivraison() {
            $.ajax({
            }).done(function () {
                //set le bouton précédent à la couleur normale
                var currentButton = $('#champ-type-intervention').val();
                $('#bouton-intervention-'+currentButton+'').attr("style","background-color:white");
                //changer couleur bouton
                $('#bouton-intervention-livraison').attr("style","color:white;background-color:blue");
                 //vider champ description
                document.getElementById('champ-description-intervention').value = "";
                //changer valeur action
                $('#champ-type-intervention').attr("value","livraison");
                //mettre les bons champs
                $('#div-champs-intervention-specifiques').html(
                        'Prestataire : <input type="text" id="champ-prestataire" name="prestataire" placeholder="prestataire" /><br>'
                        +'Objet : <input type="text" id="champ-objet" name="objet" placeholder="objet" /><br>'
                        );
                
                
                
            }).fail(function () {
                $('#nom-client').html("pas trouvé");
            });
        }
        
        function interventionIncident() {
            $.ajax({
            }).done(function () {
                //set le bouton précédent à la couleur normale
                var currentButton = $('#champ-type-intervention').val();
                $('#bouton-intervention-'+currentButton+'').attr("style","background-color:white");
                //changer couleur bouton
                $('#bouton-intervention-incident').attr("style","color:white;background-color:blue");
                 //vider champ description
                document.getElementById('champ-description-intervention').value = "";
                //changer valeur action
                $('#champ-type-intervention').attr("value","incident");
                //mettre les bons champs = aucun
                //$('#div-champs-intervention-specifiques').html('Type d\'incident : <input type="text" id="champ-type-incident" name="type-animal" placeholder="Type d\'incident" /><br>');
                $('#div-champs-intervention-specifiques').html("");
                
                
            }).fail(function () {
                $('#nom-client').html("pas trouvé");
            });
        }
        

        $(document).ready(function () {
            getNomClient();
            historique();

            // ajout d'un "handler" sur le clic du bouton de connexion
            $('#bouton-deconnexion-client').on('click', function () {
                // affichage pour debugage dans la console javascript du navigateur
                console.log('Click sur le bouton "Déconnection"');
                // appel de la fonction connexion
                deconnexionClient();
            });
        });

    </script>

</body>
</html>
